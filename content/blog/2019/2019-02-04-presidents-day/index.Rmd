---
title: "President's Day (As In: What Does the President Do With His Day?)"
author: Garrick Aden-Buie
date: '2019-02-14'
slug: presidents-day
categories:
  - Blog
tags:
  - R
  - rtweet
  - ggplot2
  - Visualization
  - Politics
Description: ''
rmd_source: https://github.com/gadenbuie/garrickadenbuie-com/blob/master/content/blog/2019/2019-02-05-presidents-day/index.Rmd
head_custom: |
  <link href="https://fonts.googleapis.com/css?family=PT+Mono" rel="stylesheet">
editor_options: 
  chunk_output_type: console
---

<!-- links -->
[axios-article]:      https://www.axios.com/donald-trump-private-schedules-leak-executive-time-34e67fbb-3af6-48df-aefb-52e02c334255.html
[axios-spreadsheet]:  https://docs.google.com/spreadsheets/d/1oITCuVsYdhNXtY7GElLelsrbjRRIPJ1ce-_v-8J1X_A/edit#gid=0
[axios-comparison]:   https://www.axios.com/donald-trump-schedule-obama-bush-clinton-513c73ff-4d15-4e7a-9676-334557a894ee.html
[vox-exec-time]:      https://www.vox.com/policy-and-politics/2019/2/4/18210345/trump-executive-time-axios-private-schedule-leak
[politico-exec-time]: https://www.politico.com/story/2018/10/29/trump-daily-schedule-executive-time-944996
[maelle-rectangle]:   https://masalmon.eu/2019/02/11/trump-schedule/
[plot.ly]:            https://plot.ly
[tidyverse]:          https://tidyverse.org
[so-rev-date]:        https://stackoverflow.com/a/43626186
[tidyeval]:           https://tidyeval.tidyverse.org/
[hrbrthemes]:         https://hrbrmstr.github.io/hrbrthemes/
[rtweet]:             https://rtweet.info
[so-plotly]:          https://stackoverflow.com/a/45802923/2022615

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE,
  cache = TRUE,
  fig.width = 9, fig.height = 10, fig.show = "hide"
)
```

```{r library, results="hide"}
library(tidyverse)
library(lubridate)
library(hrbrthemes)
library(showtext)
library(sysfonts)
library(glue)
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman")
}
pacman::p_load_gh("clauswilke/ungeviz@aeae12b")
```

```{r function-in_hours}
# Convert datetime to decimal hour of day
in_hours <- function(x) {
  hour(x) + minute(x)/60 + second(x)/60^2
}
```

```{r function-executive_categories}
executive_categories <- c(
  "executive_time" = "Executive Time",
  "event"   = "Event",
  "lunch"   = "Lunch",
  "meeting" = "Meeting",
  "no_data" = "Unknown",
  "travel"  = "Travel"
)
```

```{r function-filter_workday}
filter_workday <- function(
  df,  
  start = hms::hms(0, 0, 8), 
  end = hms::hms(0, 0, 17),
  start_var = time_start,
  end_var = time_end
) {
  start_var <- rlang::enquo(start_var)
  end_var <- rlang::enquo(end_var)
  
  df %>% 
    filter(
      date(!!start_var) == date(!!end_var),
      hms::as.hms(!!start_var) >= start, 
      hms::as.hms(!!end_var) <= end
    ) 
}
```

```{r load-exec-time}
# Exec Time Downloaded from https://docs.google.com/spreadsheets/d/1oITCuVsYdhNXtY7GElLelsrbjRRIPJ1ce-_v-8J1X_A/edit#gid=0
exec_time <-
  read_csv(
    here::here(
      "_data", "trump-exec-time",
      "axios_trump_schedule_2018-11-07--2019-02-02.csv"
    ),
    col_types = cols(.default = col_character())
  ) %>%
  mutate(
    # Convert time start/end to datetime
    event_id   = row_number(),
    time_start = paste(date, time_start),
    time_end   = paste(date, time_end),
    time_start = ymd_hm(time_start, tz = "America/New_York"),
    time_end   = ymd_hm(time_end, tz = "America/New_York"),
    time_end   = if_else(time_start > time_end, 
                         time_end + hours(24), time_end),
    # Recode the activity category with nicer labels
    top_category = factor(top_category, 
                          levels = names(executive_categories),
                          labels = executive_categories)
  ) %>% 
  mutate(
    # Create label pieces for plotly hover text
    label_title    = glue("<b>{top_category}</b>"),
    has_uniq_title = tolower(top_category) != tolower(listed_title),
    has_subtitle   = has_uniq_title & !is.na(listed_title),
    label_subtitle = if_else(has_subtitle, 
                             glue("<br><em>{listed_title}</em>"), ""),
    has_location   = !is.na(listed_location),
    label_location = if_else(has_location, 
                             glue("<br><em>{listed_location}</em>"), ""),
    label_time     = glue(
      "<br><br>{strftime(time_start, '%A, %B %e %H:%M')} ", 
      "to {strftime(time_end, '%H:%M')}"),
    has_notes      = !is.na(notes),
    label_notes    = if_else(has_notes, paste0("<br><br>", notes), ""),
    # Compose final tooltip text
    label = paste0(label_title, label_subtitle, label_location, 
                   label_time, label_notes)
  ) %>% 
  mutate(
    # truncate any activities that span 8am or 5pm
    time_start = if_else(
      in_hours(time_start) < 8 & in_hours(time_end) > 8,
      floor_date(time_start, "day") + hours(8),
      time_start
    ),
    time_end = if_else(
      in_hours(time_start) < 17 & in_hours(time_end) > 17,
      floor_date(time_end, "day") + hours(17),
      time_end
    ),
    # create 5 minute increments "inside" each activity
    time_inc   = map2(time_start, time_end, seq, by = "5 mins")
  ) %>%
  select(event_id, time_start, time_end, time_inc, 
         listed_title, top_category, label)
```

```{r get-djt-tweets, eval = FALSE}
if (FALSE) {
  djt <- NULL
  keep_going <- TRUE
  while (keep_going) {
    max_id <- if (!is.null(djt$status_id)) max(as.numeric(djt$status_id))
    djt.this <- rtweet::get_timeline("realdonaldtrump", n = 3200, max_id = max_id)
    djt <- bind_rows(djt, djt.this)
    keep_going <- min(djt$created_at) > lubridate::ymd_h("2018-11-07 0", tz = "America/New_York")
    cat("\nWe have", nrow(djt), "tweets...")
    Sys.sleep(15)
  }
  saveRDS(djt, here::here("_data", "djt-tweets-2018-09--2019-02.rds"))
}
```

```{r load-djt-tweets}
djt <- readRDS(here::here("_data", "djt-tweets-2018-09--2019-02.rds")) %>% 
  distinct(status_id, .keep_all = TRUE)
```

```{r djt-tweets}
djt_simple <- 
  djt %>% 
  filter(!is_retweet) %>% 
  mutate(
    created_at = with_tz(created_at, tzone = "America/New_York"),
    time_inc = floor_date(created_at, "5 min")
  ) %>% 
  select(created_at, time_inc, text, status_id)

djt_joined_all <- 
  exec_time %>% 
  unnest() %>% 
  filter(time_end != time_inc) %>% 
  full_join(djt_simple, by = "time_inc") %>% 
  select(
    event_id, starts_with("time_"), created_at, 
    listed_title, top_category, text
  ) %>% 
  filter(
    !is.na(text)
  ) %>% 
  distinct(text, .keep_all = TRUE) %>% 
  mutate(
    hour = in_hours(created_at), 
    date = floor_date(created_at, "day"),
    top_category = factor(top_category, executive_categories),
    label_sched = if_else(
      wday(created_at, abbr = FALSE, week_start = 1) >= 6,
      glue("<br>During: <b>Weekend</b>"),
      glue(
        "<br>During: <b>{top_category}</b>",
        "<br>Sched: {strftime(time_start, '%I:%M')} ",
        "to {strftime(time_end, '%I:%M %p')}")
    ),
    label = glue("{str_wrap(text, 50)}",
                 "<br><i>@realDonaldTrump ", 
                 "{strftime(created_at, '%a, %b %e, %I:%M %p')}</i>",
                 "{label_sched}")
  ) %>%
  select(-time_start, -time_end, -label_sched) %>% 
  arrange(created_at)

djt_joined <-
  djt_joined_all %>% 
  filter(!is.na(top_category))
```

```{r functions-am-pm}
am_pm <- function(x) {
  x <- floor(x)
  c(
    if (any(x  < 12)) paste(x[x < 12], "am"),
    if (any(x == 12)) paste(x[x == 12], "pm"),
    if (any(x  > 12)) paste(x[x > 12] - 12, "pm")
  )
}
```

```{r functions-rev-date}
# Reverse Time Axis
# thanks: https://stackoverflow.com/a/43626186
c_trans <- function(a, b, breaks = b$breaks, format = b$format) {
  library(scales)
  a <- as.trans(a)
  b <- as.trans(b)

  name <- paste(a$name, b$name, sep = "-")

  trans <- function(x) a$trans(b$trans(x))
  inv <- function(x) b$inverse(a$inverse(x))

  trans_new(name, trans, inverse = inv, breaks = breaks, format=format)

}

rev_date <- c_trans("reverse", "time")
```

```{r functions-lightbox-img}
lightbox_img <- function(url, alt = "", caption = "", preview = TRUE) {
  if (preview) {
    glue::glue(
      '<a href="{url}" data-featherlight="image">
      <div class="figure">
      <img src="{url}" alt="{alt}">
      <p class="caption">{caption}</p>
      </div>
      </a>
      '
    )
  } else {
    if (alt == "") alt <- "static image of the plot"
    glue::glue('<a href="{url}" data-featherlight="image">{alt}</a>')
  }
}
```

```{r plot-theme-fonts}
sysfonts::font_add_google("PT Sans")
sysfonts::font_add_google("PT Sans Narrow")
sysfonts::font_add_google("PT Mono")
showtext::showtext_auto()
```

```{r plot-theme}
theme_set(
  hrbrthemes::theme_ipsum(
    base_family       = "PT Sans",
    base_size         = 20,
    axis_title_family = "PT Sans Narrow",
    axis_title_size   = 14,
    axis_text_size    = 12,
    axis_title_just   = "c"
  ) +
  theme(
    plot.title       = element_text(hjust = 0.5),
    plot.subtitle    = element_text(hjust = 0.5),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    legend.position  = "bottom",
    legend.key       = element_rect(
      fill = "white", color = "white", size = 4),
    legend.key.width = unit(2, "cm"),
    legend.text      = element_text(size = 9),
    plot.caption     = element_text(
      color = "#85919b", hjust = 0, size = 12, face = "plain")
  )
)
```

```{r plot-vars}
plot_date_breaks <- seq(
  from = ymd_h("2018-11-12 0", tz = "America/New_York"),
  to   = max(exec_time$time_start),
  by   = "7 day")

event_type_colors <- c(
  "Executive Time" = "#445566",
  "Travel"  = "#997788",
  "Lunch"   = "#7c9393",
  "Meeting" = "#b7c6d6",
  "Event"   = "#ddbbaa",
  "Unknown" = "#d9dde0")

event_type_labels <- sub(" ", "\n", names(event_type_colors))
```

```{r plot-credit-caption}
credit_caption <- function(rtweet = FALSE) {
  paste0(
    "\nData:   Based on White House schedules released by Axios. http://bit.ly/2UGM0fw",
    if (rtweet) "\n           Tweets collected with {rtweet}. https://rtweet.info",
    "\nChart: @grrrck"
  )
}
```

On February 3rd, Axios [released President Trump's daily schedule][axios-article].
As in many other areas of his political career, Trump has broken with tradition by hiding his schedule from public view.

In addition to a set of re-typed PDF files, Axios also created a [Google Spreadsheet][axios-spreadsheet] containing the president's schedule and notes about the activities.
If you're interesting in reading about how that task could be accomplished, I highly recommend MaÃ«lle Salmon's post on [rectangling the tables in the PDF files][maelle-rectangle].

The leak and subsequent release by Axios provide unique insight into Trump's daily activities, which are dominated by a large block of time referred to as **Executive Time**.
Reportedly, Trump hated following a strict daily schedule, so former chief-of-staff John Kelly introduced the concept of Executive Time: unstructured time when the president ~~reads~~ watches news, makes phone calls, and writes ~~emails~~ tweets.

I won't comment extensively on what these schedules mean---for more on that angle, see reporting from [Axios][axios-comparison], [Vox][vox-exec-time], [Politico][politico-exec-time] and others.

Instead, I'll use this post to visualize the president's work day and tweeting habits and a demonstrate how to use R, [plot.ly] and the tools of the [tidyverse] to create interactive and static visualizations to try to make sense of what the president does on a daily basis.

## The President's Daily 8am to 5pm Schedule

Axios' [article on Trump's private schedule][axios-article] includes an interactive view of the president's workday schedule from 8 a.m. to 5 p.m.
Here, I recreate the same visualization, with each activity colored according to the activity's category.
(Note these plots look best on desktop devices.)

Hover over any time slot to view more details about the activity at that time.
You can also toggle activity categories --- try removing everything except **Meeting**s, **Lunch**es, and **Event**s, it's unbelievable.

```{r plot-daily-schedule, fig.show = "show", out.width="125%"}
g <-
  exec_time %>%
  mutate(date = floor_date(time_start, "day")) %>%
  filter_workday() %>% 
  mutate_at(vars(time_start, time_end), in_hours) %>%
  ggplot() +
  geom_rect(
    aes(xmin = time_start,
        xmax = time_end,
        ymin = date - 3600 * 12,
        ymax = date + 3600 * 12,
        fill = top_category)
  ) +
  scale_x_continuous(
    breaks   = seq(8, 17, 3),
    limits   = c(8, 17),
    position = "top",
    labels   = am_pm(seq(8, 17, 3)),
    expand   = expand_scale(c(0.025, 0), 0)
  ) +
  scale_y_continuous(
    trans  = rev_date,
    breaks = plot_date_breaks,
    labels = strftime(plot_date_breaks, "%b %e"),
    expand = expand_scale(c(0.025, 0), 0)
  ) +
  scale_fill_manual(
    values = event_type_colors, 
    labels = event_type_labels
  ) +
  labs(x = "Hour of the Day", y = NULL, fill = NULL) +
  ggtitle(
    "President Trump's Daily Schedule",
    "November 7, 2018 through February 2, 2019"
  ) +
  labs(caption = credit_caption(FALSE)) +
  guides(fill = guide_legend(nrow = 1, label.position = "bottom")) +
  theme(
    axis.text.y = element_text(family = "PT Mono", size = 10),
    plot.margin = margin(3, 0, 0, 0, unit = "line")
  )

plotly::ggplotly(g + aes(text = label), tooltip = "label") %>% 
  plotly::layout(xaxis = list(side = "top", title = ""))
```

```{r plot-daily-schedule-static, dependson="plot-daily-schedule"}
g +
  theme(plot.margin = margin(0, 15, 0, 15))
```

View `r lightbox_img(knitr::fig_chunk("plot-daily-schedule-static", "png"), preview = FALSE)`.
Expand the section below for a behind-the-scenes look at this visualization.


<h3 class="js-expandmore section" id="how-this-was-made-1">How This Was Made...</h3>

<div class="js-to_expand">
The pipeline for building this visualization is a fairly standard loading and transformation of the source data with `readr` and `dplyr`, followed by building the visualization in `ggplot2` and passing off to `plotly` for the interactive parts.
On the other hand, I created a number of helper functions and constants that I reused throughout this post, so there's quite a bit of code and pre-amble to get to the actual plot making.

```r
library(tidyverse)
library(plotly)
library(lubridate)
library(glue)
library(hrbrthemes)
library(showtext)
library(sysfonts)
```

#### Load the Axios Data

```{r view-load-axios, eval=FALSE, echo=TRUE}
<<function-in_hours>>

<<function-executive_categories>>  
  
<<load-exec-time>>
  
exec_time
```

```{r view-exec-time}
exec_time
```

#### Prepare to Make a Plot

To build the plot, I first create several helper functions, set the global plot theme, and create a few constants.

<h5 class="js-expandmore" id="helper-functions">Helper Functions</h5>
<div class="js-to_expand">

The first helper adds `"am"` or `"pm"` to an integer hour for easy-to-read labels on the x-axis _time of day_.

```{r view-am-pm, echo = TRUE}
<<functions-am-pm>>
  
am_pm(seq(8, 17, 3))
```

The second helper function is copied directly from [StackOverflow: Reverse datetime (POSIXct data) axis in ggplot][so-rev-date], in one of the rare-but-beautiful moments when directly copying and pasting from SO works out perfectly.
This gives me a `rev_date()` transformer function that can be passed to `scale_y_continuous(trans = rev_date)` to show the y-axis in chronological order with the earliest date starting at the top.

A third helper function abstracts the code required to filter out the portion of the data set that belongs to the workday, which I use throughout this post.
This function is a nice example of how [tidyeval] can be used for flexible dplyr wrapper functions.

```{r view-filter-workday, echo=TRUE, eval=FALSE}
<<function-filter_workday>>
```

Finally, another helper function creates the plot caption credits.

```{r view-caption-credit, echo=TRUE, eval=FALSE}
<<plot-credit-caption>>
```

</div>

<h5 class="js-expandmore" id="plot-theme">Plot Theme</h5>
<div class="js-to_expand">

I used `showtext` and `sysfonts` to match the fonts in the plot to the font used on this blog (PT Mono).

```{r view-plot-fonts, eval=FALSE, echo=TRUE}
<<plot-theme-fonts>>
```

And I used [hrbrthemes'][hrbrthemes] excellent `theme_ipsum()` as my theme's starting point.

```{r view-plot-theme, eval=FALSE, echo=TRUE}
<<plot-theme>>
```

</div>

<h5 class="js-expandmore" id="plot-constants">Plot Constants</h5>
<div class="js-to_expand">

I created a few constants for later reference: one stores date breaks for the time period covered by the Axios schedule, with labels on each Monday; and the other two store the color palette and labels for the executive activity categories.
The colors were hand-selected from a picture of the Donald (I was expecting there to be more orange).

```{r view-plot-constants, echo=TRUE, eval=FALSE}
<<plot-vars>>
```

```{r view-plot-colors, fig.width=4, fig.height=3}
scales::show_col(event_type_colors)
```

<div style="width: 100%">
<img src="`r knitr::fig_chunk("view-plot-colors", "png")`" style="max-width: 300px; margin: auto;" />
</div>

</div>

#### Build the Actual Plot Already!

Finally, I pulled the schedule data and all of the above pieces together to build the interactive plot.

```{r view-plot-daily-schedule, eval=FALSE, echo=TRUE}
<<plot-daily-schedule>>
```

</div>

## The President's Daily Tweeting Schedule

```{r djt-workday}
djt_axios_sched <-
  djt_joined_all %>%
  filter(date >= "2018-11-07", date <= "2019-02-02") %>% 
  mutate(
    weekend = wday(created_at, abbr = FALSE, week_start = 1) >= 6,
    weekend = if_else(weekend, "weekend", "weekday")
  ) %>% 
  select(-text)

djt_workday <- 
  djt_axios_sched %>% 
  filter_workday(
    start_var = created_at, end_var = created_at
  )
```

```{r djt-workday-for-text}
djt_per_workday <- 
  djt_axios_sched %>% 
  filter_workday(
    start_var = created_at, end_var = created_at
  ) %>% 
  group_by(weekend) %>% 
  count(date) %>% 
  summarize(
    tweets = sum(n), 
    n = n(), 
    mean = tweets/n) %>% 
  split(.$weekend)

djt_per_day <- 
  djt_axios_sched %>% 
  group_by(weekend) %>% 
  count(date) %>% 
  summarize(
    tweets = sum(n), 
    n = n(), 
    mean = tweets/n) %>% 
  split(.$weekend)
```

Donald Trump tweets about 
`r round(djt_per_workday$weekday$mean, 1)`
tweets per working day within working hours.
Why does this number feel so low? 
Then again, this represents 
`r djt_per_workday$weekday$tweets` 
tweets pubslished over 
`r djt_per_workday$weekday$n` 
workdays and 
`r djt_per_workday$weekend$tweets` 
tweets over the 
`r djt_per_workday$weekend$n` 
weekend days in the same time period.
Outside of work hours, the average rises to
`r round(djt_per_day$weekday$mean, 1)`
tweets per 24-hour workday,
or a total of
`r djt_per_day$weekday$tweets`
tweets on workdays and
`r djt_per_day$weekend$tweets`
tweets on weekends.

Below, each tweet sent by the President is shown as a dot over his private schedule.
Hover over a tweet's dot to read the text of the tweet.

```{r plot-tweets-over-category, fig.show = "show", out.width="125%"}
# Modify geom_rect (only layer) to reduce transparency
g_subdued <- g
g_subdued$layers[[1]]$aes_params$alpha <- 0.6

# Add tweets to the plot
g_subdued <- 
  g_subdued + 
  ggtitle("President Trump's Daily Tweeting") +
  geom_point(
    data = djt_workday,
    aes(x = hour, y = date + 3600, text = label),
    color = "#2c3741",
    size = 0.8
  )

gpltly <- 
  plotly::ggplotly(g_subdued, tooltip = "label") %>% 
  plotly::layout(xaxis = list(side = "top", title = ""))

# remove hover labels for time category layers (6 categories)
# thanks: https://stackoverflow.com/a/45802923/2022615
for (i in 1:6) {
  gpltly$x$data[[i]]$hoverinfo <- "none"
}
gpltly
```

```{r plot-tweets-over-category-static}
g_subdued +
  theme(plot.margin = margin(0, 15, 0, 15))
```

View `r lightbox_img(knitr::fig_chunk("plot-tweets-over-category-static", "png"), preview = FALSE)`.

<h3 class="js-expandmore" id="how-this-was-made-2">How This Was Made...</h3>
<div class="js-to_expand">

This visualization required the President's tweets, which I downloaded using the excellent [rtweet] package.
After matching the tweets with their corresponding activity, I modified the previous plot to soften the coloring of the presidential activities and added the tweets to the chart.

### Download the President's Tweets

Using the [rtweet] package makes downloading the tweets relatively straightforward.
I only needed to add a loop to gather tweets beyond Twitter's timeline API limits and ensure that I have all the tweets from the time period described in the leaked schedules.

```{r view-get-djt-tweets, echo=TRUE, eval=FALSE}
# Change to `if (TRUE)` to run
<<get-djt-tweets>>
```

### Join Tweets with the President's Schedule

To align the tweets with the President's schedule, I rounded (actually, floored) the timestamp of each tweet down to the nearest 5 minute interval.
Then, I joined the tweets to the schedule using the 5 minute intervals I created while importing the schedule (see above).
This gives me the category and scheduled activity of each tweet.

```{r view-djt-tweets, eval=FALSE, echo=TRUE}
<<djt-tweets>>
```

Finally, I still need to do a little bit of processing to get these tweets to fit into the previous plot.

```r
djt_workday <- 
  djt_joined_all %>%
  filter_workday(
    start_var = created_at, end_var = created_at
  ) %>% 
  filter(date >= "2018-11-07", date <= "2019-02-02") %>% 
  select(-text)
```

At this point, there are a few versions of the tweets data set that I can use in different places.
The `djt_simple` is a basic, bare-bones tibble of tweets.

```{r view-djt-simple}
djt_simple %>% 
  arrange(created_at) %>% 
  filter(created_at >= "2018-11-07")
```

The `djt_joined_all` variable holds the complete set of all tweets joined with the full schedule, meaning that there will be missing values where no tweets occurred in a 5 minute window or where the schedule data doesn't cover a tweet.

```{r view-djt-joined-all}
set.seed(4242)
top_10 <- sample(1:nrow(djt_joined_all), 10)
header_rows <- c(
  sort(top_10),
  setdiff(1:nrow(djt_joined_all), top_10)
)
djt_joined_all %>% 
  slice(header_rows) %>% 
  select(time_inc, top_category, text, everything())
```

And `djt_workday` contains the tweets within the period covered by the Axios schedules and during workday hours.

```{r view-djt-workday}
djt_workday %>% 
  select(time_inc, top_category, label, everything())
```

### Add Tweets to the Schedule Plot

To build the second plot, I had to manually tweak the first plot to adjust the transparency of the `geom_rect` layer and add the tweets

```r
`r paste(knitr:::knit_code$get("plot-tweets-over-category")[1:14], collapse = "\n")`
```

At this point, the plot is almost ready to go, except for the fact that the tooltip text will appear for the underlying activity layers.
Fortunately, once again [StackOverflow][so-plotly] comes to the rescue.
To disable the tooltip, I have to save the plotly object and change the `$hoverinfo` value to `"none"` for each of the data layers of the activity categories.

```r
`r paste(knitr:::knit_code$get("plot-tweets-over-category")[16:25], collapse = "\n")`
```

<div>

```{r plot-time-categoy-pct}
# Plot 2 ------------------------------------------------------------------
exec_time_total <-
  exec_time %>%
  filter(between(hour(time_start), 8, 17), hour(time_start) < 17) %>%
  mutate(
    date = floor_date(time_start, "day"),
    n = difftime(time_end, time_start, units = "mins"),
    n = as.numeric(n)
  ) %>%
  group_by(date, top_category) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  mutate(n = n / (60 * 9)) %>%
  # Get unaccounted time for each date (unknown or unlabelled)
  nest(-date) %>%
  mutate(
    total = map_dbl(data, ~ {
      filter(., top_category != "Unknown") %>% 
        pull(n) %>% 
        sum()
    }),
    unaccounted = 1 - total,
  ) %>%
  unnest() %>%
  spread(top_category, n, fill = 0) %>%
  mutate(`Unknown` = unaccounted) %>%
  select(-total, -unaccounted) %>%
  gather("top_category", "n", -date) %>%
  mutate(top_category = factor(top_category, rev(names(event_type_colors))))


ggplot(exec_time_total) +
  aes(date + 3600*12, n, fill = top_category) +
  geom_col(width = 3600*24) +
  scale_fill_manual(values = event_type_colors, labels = rev(event_type_labels)) +
  scale_y_continuous(
    breaks   = seq(0, 1, .25),
    labels   = scales::percent_format(accuracy = 25),
    position = "bottom",
    expand   = expand_scale(c(0.025, 0), 0)
  ) +
  scale_x_continuous(
    trans  = rev_date,
    breaks = plot_date_breaks,
    labels = strftime(plot_date_breaks, "%b %e"),
    expand = expand_scale(c(0.025, 0), 0)
  ) +
  coord_flip() +
  labs(x = NULL, y = "Percent of Workday Between 8am and 5pm", fill = NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE, label.position = "bottom")) +
  ggtitle(
    "What Does President Trump Do With His Time?"
  ) +
  labs(caption = credit_caption(FALSE))
```

`r lightbox_img(knitr::fig_chunk("plot-time-categoy-pct", "png"))`

```{r plot-tweet-counts-by-activity, fig.height = 5}
exec_time_boundaries <- 
  exec_time %>% 
  summarize(min = min(time_start), max = max(time_end))

exec_time %>%
  # mutate(event_id = row_number()) %>%
  unnest() %>%
  filter(time_end != time_inc) %>%
  full_join(djt_simple, by = "time_inc") %>%
  select(event_id, time_inc, created_at, listed_title, top_category, text) %>%
  filter(!is.na(text)) %>%
  filter(between(time_inc, exec_time_boundaries$min, exec_time_boundaries$max)) %>%
  mutate(
    wday = wday(created_at, abbr = FALSE, week_start = 1), 
    top_category = case_when(
      !is.na(top_category) ~ paste(top_category),
      wday > 5 ~ "Weekend", 
      between(wday, 1, 5) & hour(created_at) < 6 ~ "Early Morning (before 6am)",
      between(wday, 1, 5) & hour(created_at) < 8 ~ "Morning (6-8 am)",
      between(wday, 1, 5) & hour(created_at) > 17 ~ "Evening (after 5pm)",
      is.na(top_category) ~ "Unknown",
      TRUE ~ paste(top_category))
  ) %>%
  group_by(top_category) %>%
  count() %>% 
  ungroup() %>% 
  arrange(n) %>% 
  mutate(top_category = fct_inorder(top_category)) %>% 
  ggplot() + 
  aes(top_category, n) + 
  geom_col(fill = "#445566") + 
  coord_flip() +
  labs(x = "Activity or Time of Day", 
       y = paste(
         "Total Tweets Sent Between",
         strftime(exec_time_boundaries$min, "%F"),
         "to",
         strftime(exec_time_boundaries$max, "%F")
       ),
       title = "Trump Tweet Volume by Scheduled Activity",
       caption = credit_caption(rtweet = TRUE))
```

`r lightbox_img(knitr::fig_chunk("plot-tweet-counts-by-activity", "png"))`

```{r djt-tweets-timeline}
ggplot(djt_joined) + 
  ungeviz::geom_vpline(
    aes(x = hour, y = top_category, color = top_category),
    size = 0.6
  ) +
  scale_x_continuous(
    breaks   = seq(8, 17, 3),
    limits   = c(8, 17),
    position = "bottom",
    labels   = am_pm(seq(8, 17, 3)),
    expand   = expand_scale(c(0.025, 0), 0)
  ) +
  scale_color_manual(values = event_type_colors, labels = event_type_labels) +
  labs(x = NULL, y = NULL, color = NULL) +
  guides(color = guide_legend(nrow = 1, label.position = "bottom", override.aes = list(size = 2))) +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle(
    "What's On His Schedule When He's Tweeting?",
    "Each line represents a tweet, colored by the activity on his White House Schedule"
  ) + 
  labs(caption = credit_caption(rtweet = TRUE))
```

`r lightbox_img(knitr::fig_chunk("djt-tweets-timeline", "png"))`

```{r tweets-by-exec-time, fig.height=5}
djt_joined %>%
  group_by(date) %>%
  count() %>%
  rename(tweets = n) %>%
  left_join(exec_time_total, ., by = "date") %>%
  replace_na(list(tweets = 0)) %>% 
  filter(top_category %in% c("Executive Time", "Unknown", "Travel", "Lunch")) %>%
  spread(top_category, n, fill = 0) %>% 
  filter(!Unknown == 1) %>% 
  mutate(pct = Unknown + `Executive Time` + Travel + Lunch) %>% 
  ggplot() +
  aes(pct, tweets) +
  geom_smooth(
    method = "lm", 
    color = event_type_colors["Executive Time"], 
    fill = event_type_colors["Unknown"]
  ) +
  geom_point(color = event_type_colors["Executive Time"]) + 
  scale_x_continuous(labels = scales::percent_format(10)) +
  labs(
    x = "Percent of Workday Dedicated to Downtime\n(Executive Time, Travel, Unknown)", 
    y = "Number of Tweets", 
    title = "Does Trump Tweet More When He Has More Downtime?",
    caption = credit_caption(rtweet = TRUE))
```

`r lightbox_img(knitr::fig_chunk("tweets-by-exec-time", "png"))`

```{r tweets-by-not-meeting-event, fig.height=5}
djt_simple %>%
  mutate(date = floor_date(created_at, "day")) %>%
  group_by(date) %>%
  count() %>%
  rename(tweets = n) %>%
  left_join(exec_time_total, ., by = "date") %>%
  filter(top_category %in% c("Meeting", "Event")) %>%
  group_by(date) %>% 
  summarize(pct = sum(n), tweets = max(tweets)) %>% 
  filter(pct > 0) %>% 
  ggplot() +
  aes(pct, tweets) +
  geom_smooth(
    method = "lm", 
    color = event_type_colors["Executive Time"], 
    fill = event_type_colors["Unknown"]
  ) +
  geom_point(color = event_type_colors["Executive Time"]) +
  scale_x_continuous(labels = scales::percent_format(10)) +
  labs(x = "Percent of Workday Dedicated to Meetings or Events", 
       y = "Number of Tweets",
       title = "Does Trump Tweet Less When He Does More \"Work\"?",
       caption = credit_caption(rtweet = TRUE))
```

`r lightbox_img(knitr::fig_chunk("tweets-by-not-meeting-event", "png"))`

```{r tweet_sentiment, fig.height=8}
djt_sentiment <- 
  djt_joined %>% 
  select(top_category, text) %>% 
  mutate(sentiment = map(text, syuzhet::get_nrc_sentiment)) %>% 
  unnest() %>% 
  gather(emotion, value, -top_category, -text)

djt_sentiment_mean <- 
  djt_sentiment %>% 
  group_by(top_category, emotion) %>% 
  summarize(value = mean(value)) %>% 
  mutate(emotion = fct_reorder(emotion, value)) %>% 
  filter(top_category != "Unknown")

ggplot(djt_sentiment_mean) +
  geom_rect(
    data = tibble(
      ymin = seq(0, 9, 2) + 0.5,
      ymax = seq(0, 9, 2) + 1.5,
      xmin = -Inf, xmax = Inf
    ),
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
    fill = "grey95"
  ) +
  ungeviz::geom_vpline(aes(x = value, y = as.integer(emotion), color = top_category),
                       height = 0.8, size = 1.75) +
  # geom_point(aes(x = value, y = as.integer(emotion), color = top_category)) +
  scale_color_manual(values = event_type_colors, labels = event_type_labels[-6]) +
  scale_y_continuous(breaks = 1:10, labels = levels(djt_sentiment$emotion)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 2.5)) +
  guides(color = guide_legend(title = NULL, label.position = "bottom")) +
  labs(x = "Average Sentiment of Tweets", y = NULL) +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle(
    "Emotional Valence of Trump Tweets",
    "As a function of what he was doing at the time"
  ) + 
  labs(caption = credit_caption(rtweet = TRUE))
```

`r lightbox_img(knitr::fig_chunk("tweet_sentiment", "png"))`

```{r tweet-emotion-by-event, fig.height=7}
# djt_sentiment %>%
#   mutate(emotion = factor(emotion, rev(c("positive", "joy", "trust", "surprise", "anticipation", "fear", "sadness", "anger", "disgust", "negative")))) %>%
#   ggplot() +
#   aes(value, emotion, fill = top_category) +
#   ggridges::geom_density_ridges() +
#   scale_fill_manual(values = event_type_colors) +
#   facet_wrap(~top_category)

djt_sentiment %>%
  mutate(emotion = factor(emotion, rev(c("positive", "joy", "trust", "surprise", "anticipation", "fear", "sadness", "anger", "disgust", "negative")))) %>%
  ggplot() +
  aes(y = value, x = emotion, fill = top_category) +
  # ggridges::geom_density_ridges() +
  geom_boxplot(alpha = 0.7, color = "grey20", outlier.shape = NA) +
  scale_fill_manual(values = event_type_colors) +
  guides(fill = FALSE, color = FALSE) + 
  coord_flip() +
  facet_wrap(~top_category, scales = "free_y") + 
  labs(y = "Sentiment Score", x = NULL,
       title = "Emotions Expressed in Trump Tweets",
       caption = credit_caption(rtweet = TRUE))
```

`r lightbox_img(knitr::fig_chunk("tweet-emotion-by-event", "png"))`
