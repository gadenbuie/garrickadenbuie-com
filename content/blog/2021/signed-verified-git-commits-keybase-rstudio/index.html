---
title: 'Signed and verified: signed git commits with Keybase and RStudio'
author: Garrick Aden-Buie
date: '2021-09-13'
slug: signed-verified-git-commits-keybase-rstudio
categories:
  - Blog
tags:
  - R
  - git
  - GitHub
  - RStudio
  - Tutorials
description: "Setting up signed git commits with a Keybase GPG key that works with RStudio."
images:
  - "/blog/signed-verified-git-commits-keybase-rstudio/social.png"
rmd_source: 'https://github.com/gadenbuie/garrickadenbuie-com/blob/main/content/blog/2021/signed-verified-git-commits-keybase-rstudio/index.Rmd'
keywords: "rstats"
---

<script src="{{< blogdown/postref >}}index_files/header-attrs-2.10/header-attrs.js"></script>
<script src="{{< blogdown/postref >}}index_files/clipboard-2.0.6/clipboard.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.js"></script>
<script>window.xaringanExtraClipboard('pre[class]', {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>


<!-- Links -->
<div class="lead">
<p>Cryptographically sign all of your commits
with a GPG key managed by Keybase,
proving to GitHub and the world that you are a real person who really wrote your code
and getting that neat <strong>Verified</strong> badge next to all of your commits.</p>
<p>Along the way, we’ll also make sure everything is set up in a way that plays nicely with RStudio.</p>
</div>
<div class="center">
<div class="figure">
<img src="verified.png" alt="" />
<p class="caption">A verified commit on GitHub with the green <em>Verified</em> badge.</p>
</div>
</div>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Did you know it’s incredibly easy to
<a href="https://blog.gruntwork.io/how-to-spoof-any-user-on-github-and-what-to-do-to-prevent-it-e237e95b8deb">spoof commit authors with git</a>?
Basically, you only need to tell <code>git</code> you’re a different person.</p>
<pre class="bash"><code>git config --global user.email &quot;hadley@...&quot;
git config --glboal user.name &quot;Hadley Wickham&quot;

# pretend to commit as Hadley
git commit -m &quot;Fix recode() arguments to new = old&quot;</code></pre>
<p><code>git</code> <em>doesn’t do anything</em> to verify the commit author and,
while GitHub will try a little harder than <code>git</code>,
it’s surprisingly easy to pretend to be somewhere else in a git repo.</p>
<p>This can obviously lead to problems
(that are admittedly mostly theoretical in my daily life)
and there’s a relatively easy solution: signed commits.
With signed commits,
you cryptographically sign each commit with your private key that only you own,
and GitHub (and others) will verify your signature with the public key pair.
When GitHub knows that the real you made the commit,
it adds the green
<img src="verified-small.png" alt="verified" style="display:inline;margin:0;vertical-align:middle" height="24">
badge.</p>
<p>In this post,
I’ll show you how to use Keybase to create your own GPG key.
Then we’ll set up <code>git</code> to use this key to sign your commits,
and along the way we’ll configure <code>git</code> to work with RStudio, too.
I’m using a Mac, but the process is very similar for Linux/Unix
machines<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
</div>
<div id="set-up-signed-and-verified-commits" class="section level2">
<h2>Set up signed and verified commits</h2>
<div id="install-keybase-and-gpg" class="section level3">
<h3>Install Keybase and GPG</h3>
<p>We need at least four pieces of software to make this work.
I’m hoping you have <a href="https://git-scm.com/">git</a><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> and <a href="https://www.rstudio.com">RStudio</a> installed;
the two new things you’ll probably need are <a href="https://keybase.io">Keybase</a> and <a href="https://gnupg.org/">gpg</a>.</p>
<p>The easiest way to install both is with the MacOS package manager, <a href="https://brew.sh">homebrew</a>.
(If homebrew is new to you, head over to <a href="https://brew.sh/" class="uri">https://brew.sh/</a> to learn more and to grab the installation command.)</p>
<pre class="bash"><code>brew install gpg
brew install --cask keybase</code></pre>
<p>The first line installs <code>gpg</code>,
the <a href="https://gnupg.org/">GNU Privacy Guard</a> command line tool.
It manages the cryptographic steps:
signing or encoding files with your personal GPG key.</p>
<p><a href="https://keybase.io">Keybase</a> is
<em>key directory that maps social media identities to encryption keys in a publicly auditable manner<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a></em>.
In other words,
Keybase is place to store encryption keys
and to link your identity (and those keys)
to your public identities such as your accounts on <a href="https://twitter.com">Twitter</a> or <a href="https://github.com">GitHub</a>.
One advantage of Keybase is that its app and command line tool
make it relatively easy to generate and store GPG keys.
It’s also a great way to share that key between your own computers.</p>
</div>
<div id="create-a-gpg-key-with-keybase" class="section level3">
<h3>Create a GPG key with Keybase</h3>
<p>If you don’t have a Keybase account,
open the Keybase app that we installed with <code>brew</code>.
Their app will guide you through the process of creating an account.</p>
<p>Once you have a Keybase account,
head back to the command line<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>
to create a new GPG key.
Note that the <code>keybase</code> cli uses the <code>pgp</code> command,
but we’ve been talking about <em>GPG</em> keys.
To most people, the terms GPG and PGP are functionally interchangeable:
GPG is the <a href="https://gnupg.org/">GNU Privacy Guard</a>
which is an open-source version of
PGP (<a href="https://en.wikipedia.org/wiki/Pretty_Good_Privacy">Pretty Good Privacy</a>).</p>
<pre class="bash"><code>keybase pgp gen --multi</code></pre>
<pre><code>Enter your real name, which will be publicly visible in your new key: Garrick Aden-Buie
Enter a public email address for your key: garrick@adenbuie.com
Enter another email address (or &lt;enter&gt; when done):
Push an encrypted copy of your new secret key to the Keybase.io server? [Y/n] Y
When exporting to the GnuPG keychain, encrypt private keys with a passphrase? [Y/n] Y
▶ INFO PGP User ID: Garrick Aden-Buie &lt;garrick@adenbuie.com&gt; [primary]
▶ INFO Generating primary key (4096 bits)
▶ INFO Generating encryption subkey (4096 bits)
▶ INFO Generated new PGP key:
▶ INFO   user: Garrick Aden-Buie &lt;garrick@adenbuie.com&gt;
▶ INFO  4096-bit RSA key, ID B606B038A1A5CE20, created 2021-09-12
▶ INFO Exported new key to the local GPG keychain</code></pre>
<p>To recap the process:</p>
<ul>
<li><p><code>keybase</code> will first ask you for your real name and email address.
Make sure these match your identity on GitHub, or at least a
<a href="https://github.com/settings/emails">verified email that you use on GitHub</a>.</p></li>
<li><p>Then choose <code>Y</code> to push a copy of the key to Keybase
and <code>Y</code> again to add give your private key a passphrase.</p></li>
<li><p>After a few seconds, Keybase asks for your account password
and then prompts you to enter a passphrase for your GPG key.</p></li>
</ul>
<p>At the end of the output, note your key’s ID —
in my case, <code>B606B038A1A5CE20</code>.
You should also be able to find your key on your Keybase profile,
or list your local keys that <code>gpg</code> knows about with</p>
<pre class="bash"><code>gpg --list-secret-keys --keyid-format LONG</code></pre>
<pre><code>/Users/garrick/.gnupg/pubring.kbx
---------------------------------
sec   rsa4096/B606B038A1A5CE20 2021-09-13 [SC] [expires: 2037-09-09]
      87888BBEBC09E6093A8310F9B606B038A1A5CE20
uid                 [ unknown] Garrick Aden-Buie &lt;garrick@adenbuie.com&gt;
ssb   rsa4096/F4435076C9C363BD 2021-09-13 [E] [expires: 2037-09-09]</code></pre>
<p>Notice that we again see our key id,
<code>B606B038A1A5CE20</code>, in the third line of the output.
There’s also the <code>[ unknown]</code> on line 5 next to our name.
This indicates that <code>gpg</code> isn’t totally confident about this key yet
and we need to tell <code>gpg</code> that it can be trusted.</p>
</div>
<div id="trust-your-own-key-ultimately" class="section level3">
<h3>Trust your own key, ultimately</h3>
<p>Open the <code>gpg</code> interactive prompt to edit your key, then run <code>trust</code>,
choose <code>I trust ultimately</code> and finally run <code>save</code>.</p>
<pre class="bash"><code>gpg --edit-key B606B038A1A5CE20</code></pre>
<pre><code>gpg&gt; trust
# Please decide how far you trust this user to correctly verify other users&#39; keys
# (by looking at passports, checking fingerprints from different sources, etc.)
#
#   1 = I don&#39;t know or won&#39;t say
#   2 = I do NOT trust
#   3 = I trust marginally
#   4 = I trust fully
#   5 = I trust ultimately
#   m = back to the main menu
#
# Your decision? 5
# Do you really want to set this key to ultimate trust? (y/N) y

gpg&gt; save
# Key not changed so no update needed.</code></pre>
<p>Now if you run <code>gpg --list-secret-keys</code> again,
you’ll see <code>[ultimate]</code> next to your name.</p>
<pre class="bash"><code>gpg --list-secret-keys --keyid-format LONG</code></pre>
<pre><code>/Users/garrick/.gnupg/pubring.kbx
---------------------------------
sec   rsa4096/B606B038A1A5CE20 2021-09-13 [SC] [expires: 2037-09-09]
      87888BBEBC09E6093A8310F9B606B038A1A5CE20
uid                 [ultimate] Garrick Aden-Buie &lt;garrick@adenbuie.com&gt;
ssb   rsa4096/F4435076C9C363BD 2021-09-13 [E] [expires: 2037-09-09]</code></pre>
</div>
<div id="configure-git-to-always-sign-your-commits" class="section level3">
<h3>Configure git to always sign your commits</h3>
<p>Setting <code>git</code> to always sign your commits is straightforward.
Update the git global config to sign commits using your default key
with the following two commands,
replacing my key id in the first command with <em>your</em> key id.</p>
<pre class="bash"><code>git config --global user.signingkey B606B038A1A5CE20
git config --global commit.gpgsign true</code></pre>
</div>
<div id="add-your-key-to-github" class="section level3">
<h3>Add your key to GitHub</h3>
<p>Now you need to tell GitHub about your new GPG key.
Using your key id, ask Keybase to export the public key that matches your private GPG key.
Here we’ll pipe it to <code>pbcopy</code> to copy it into the system clipboard.</p>
<pre class="bash"><code>keybase pgp export -q B606B038A1A5CE20 | pbcopy</code></pre>
<p>Then head over to <a href="https://github.com/settings/keys">github.com/settings/keys</a>,
click on <strong>New GPG key</strong>,
and paste and add your key into GitHub.</p>
</div>
<div id="check-your-signed-commit-powers" class="section level3">
<h3>Check your signed commit powers</h3>
<p>At this point,
<code>git</code> will <em>try</em> to sign your commits,
but if you’re also using MacOS like me
there’s a good chance you’ll run into a problem when you try to commit a file.</p>
<pre class="bash"><code># in a git repo
touch test.txt
git add test.txt
git commit -m &quot;test signed commits&quot;
# error: gpg failed to sign the data
# fatal: failed to write commit object</code></pre>
<p>This error message isn’t entirely helpful,
but you can try to sign some random text with <code>gpg</code>
to expose the underlying error.</p>
<pre class="bash"><code>echo &quot;test&quot; | gpg --clear-sign</code></pre>
<pre><code>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

test
gpg: signing failed: Inappropriate ioctl for device
gpg: [stdin]: clear-sign failed: Inappropriate ioctl for device</code></pre>
<p>The problem in my case is that I have an “Inappropriate ioctl for device”.
Take that error to your <a href="https://duckduckgo.com">favorite web search engine</a>
and you’ll find a resolution.
If you also run into this <code>ioctl</code> error,
you need to add the following line to <code>~/.zshrc</code> (if you’re using
<a href="https://en.wikipedia.org/wiki/Z_shell">Z shell</a>, the latest default on MacOS) or <code>~/.profile</code>:</p>
<pre class="bash"><code>export GPG_TTY=$(tty)</code></pre>
<p>Save the file and then close and re-open your terminal window.
When you test <code>gpg</code> signing again,
you should be prompted with a full-terminal prompt to enter your password.</p>
<pre class="bash"><code>echo &quot;test&quot; | gpg --clear-sign</code></pre>
<pre><code>
 ┌───────────────────────────────────────────────────────────────┐
 │ Please enter the passphrase to unlock the OpenPGP secret key: │
 │ &quot;Garrick Aden-Buie &lt;garrick@adenbuie.com&gt;&quot;                    │
 │ 4096-bit RSA key, ID B606B038A1A5CE20,                        │
 │ created 2021-09-13.                                           │
 │                                                               │
 │                                                               │
 │ Passphrase: _________________________________________________ │
 │                                                               │
 │         &lt;OK&gt;                                   &lt;Cancel&gt;       │
 └───────────────────────────────────────────────────────────────┘
</code></pre>
<p>Enter your key’s passphrase and, if everything works, you should see a message like this:</p>
<pre><code>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

test
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEEh4iLvrwJ5gk6gxD5tgawOKGlziAFAmE/UYkACgkQtgawOKGl
ziAzgg/7Bl6cCapi+k2OrxPafl811G4x7fC4PQWCJKWXinUjkZK/8+o6jM+ZQp+4
gc1wv0gBfNyKNkTmMg/qiQhuLYiujSH9pyjaoMgO9QoYvUuPituSjV7RQOfAhlHD
N+wgkACPd3PH2kQVFj8Jw3Nkesrpgby9t/S6sSiLZf284rMfx31ua1/l4tsHWowP
5a+FRujDtarWJ1/zL9pgMkr9kkWEejqpzGVLrVKrB3xsPLyGnPf8BW+an7CwkkDS
umJulX3Ck1u14DRgIyj4VdwfCkkCle0uyZcLorZsqDP5GC/3ZKcpDe6XgSSKz0O0
HVvm4bTqBBmesVNWHVuFmYGmmXFU/sYvYoHOy3wvLiCu/hbRhBvboUcogW79/PWR
Gw/DYln5W1ClIKH9LsU0GpydSTMMhXZySEp+r1OCl4sQqKCe6Ka3ex+3lOHyym7F
U5rgfH6tmu6U2Jtn8QEFg106vxQDQ76TIRVS9xvicH98PJQnhoyg3jtu5tMbITz1
oev0Z11vq76mw3MFmVx455AVqxplGM/4qB9HsmNWTsi0fGoFa/vlbBN3vJQn0xaX
2PSXKWlkZiyd+WplWsOH2OnZ8V8s2cHNxlKsSPrWQNflYsDtO8vANwAFjiJK2Bkq
YLPCcwzEVSwFrLRRXt5Crcpc/32ZqrfvcLe0G+ACWQYAhktwJnQ=
=S1iU
-----END PGP SIGNATURE-----</code></pre>
<p>And if you try to <code>git commit</code> again, it should work!</p>
<pre class="bash"><code>git commit -m &quot;test signed commits&quot;</code></pre>
<pre><code>[main (root-commit) 4c4573f] test signed commits
 1 file changed, 0 insertions(+), 0 deletions(-)
 create mode 100644 test.txt</code></pre>
<p>Note that you can be extra sure by looking at the <code>git</code> log with signatures.</p>
<pre class="bash"><code>git log --show-signature</code></pre>
<pre><code>commit 4c4573f2fbed44eab6c0f4a08a38a9f8292580cf (HEAD -&gt; main)
gpg: Signature made Mon Sep 13 09:34:59 2021 EDT
gpg:                using RSA key 87888BBEBC09E6093A8310F9B606B038A1A5CE20
gpg: Good signature from &quot;Garrick Aden-Buie &lt;garrick@adenbuie.com&gt;&quot; [ultimate]
Author: Garrick Aden-Buie &lt;garrick@adenbuie.com&gt;
Date:   Mon Sep 13 09:34:59 2021 -0400

    test signed commits</code></pre>
</div>
<div id="install-a-pinentry-app" class="section level3">
<h3>Install a pinentry app</h3>
<p>Remember that console dialog that appeared when we committed our test commit above?
Yes, it’s fun and retro,
but it isn’t going to work inside RStudio
when the IDE runs <code>git</code> commands for you to commit your files.</p>
<p>In this step, we’ll install <code>pinentry-mac</code>,
a modern method for providing a passphrase for your key,
that also integrates with MacOS’s Keychain
so you don’t have to enter the passphrase with every commit.</p>
<p>If you’re using Windows, you might want to check out the <a href="https://www.gpg4win.org/">Gpg4win app</a>.
On Linux,
you may want to use <a href="http://manpages.ubuntu.com/manpages/bionic/man1/pinentry-gnome3.1.html">pinentry-gnome3</a>.
Finally,
you could also <a href="#gpg-agent-cache-passphrase">configure <code>gpg-agent</code> to cache your passphrase</a>
if none of the above options work for you.</p>
<p>Installing <code>pinentry-mac</code> is easy with <code>brew</code>:</p>
<pre class="bash"><code>brew install pinentry-mac</code></pre>
<p>Then we need to configure <code>gpg</code> to use <code>pinentry-mac</code> for its passphrase needs.
Add the line below to <code>~/.gnupg/gpg-agent.conf</code>:</p>
<pre class="bash"><code># vim ~/.gnupg/gpg-agent.conf
pinentry-program /usr/local/bin/pinentry-mac</code></pre>
<p>Or you can create the file and add the line in one command:</p>
<pre class="bash"><code>echo &quot;pinentry-program /usr/local/bin/pinentry-mac&quot; &gt;&gt; ~/.gnupg/gpg-agent.conf</code></pre>
<p>Finally, restart the <code>gpg-agent</code> so that <code>pinentry-mac</code> is used for passphrase entry.</p>
<pre class="bash"><code>gpgconf --kill gpg-agent</code></pre>
<p>When you create your next commit in RStudio,
you’ll be prompted with a dialog box to enter your passphrase.
If you select the <em>Save in Keychain</em> option,
you won’t be prompted again;
<code>gpg</code> and <code>git</code> will use the passphrase in your Keychain
to sign your commit with the GPG key you created with Keybase!</p>
<div class="figure">
<img src="rstudio-pinentry-mac.png" alt="" />
<p class="caption">The <code>pinentry-mac</code> dialog window asking for the GPG key passphrase when signing a commit for the first time.</p>
</div>
</div>
<div id="import-your-gpg-key-on-another-computer" class="section level3">
<h3>Import your GPG key on another computer</h3>
<p>If you’d like to use the same GPG key on another computer,
first make sure that you have <a href="#install-keybase-and-gpg">Keybase and gpg installed</a>.
Then you can export the existing key
(both its public and secret versions)
from Keybase into <code>gpg</code>:</p>
<pre class="bash"><code>keybase pgp export -q B606B038A1A5CE20 | gpg --import
keybase pgp export -q B606B038A1A5CE20 --secret | gpg --allow-secret-key-import --import</code></pre>
<p>Again, you’ll want to tell <code>gpg</code> to <a href="#trust-your-own-key-ultimately">trust this key ultimately</a>.</p>
<pre class="bash"><code>gpg --edit-key B606B038A1A5CE20
gpg&gt; trust
# pick &quot;5 = I trust ultimately&quot;
gpg&gt; save</code></pre>
</div>
</div>
<div id="links-and-resources" class="section level2">
<h2>Links and Resources</h2>
<p>Here’s a short list of links that were helpful to me while figuring out this process.
Hopefully, everything above <em>just works</em> for you,
but if not then maybe the posts below will help you out:</p>
<ul>
<li><p><a href="https://github.com/pstadler/keybase-gpg-github">pstadler/keybase-gpg-github: Step-by-step guide on how to create a GPG key on keybase.io, adding it to a local GPG setup and use it with Git and GitHub.</a></p></li>
<li><p><a href="https://stephenreescarter.net/signing-git-commits-with-a-keybase-gpg-key/">Sign Git Commits With A Keybase GPG Key – Stephen’s Thoughts</a></p></li>
<li><p><a href="https://byparker.com/blog/2021/gpg-pinentry-mac-git/">Sign commits with a GPG key using a passphrase with pinentry-mac | By Parker</a></p></li>
<li><p><a href="https://github.com/Homebrew/homebrew-core/issues/14737">gnupg2: gpg: public key decryption failed: Inappropriate ioctl for device · Issue #14737 · Homebrew/homebrew-core</a></p></li>
<li><p><a href="https://github.com/rstudio/rstudio/issues/1865">Support signing of git commits · Issue #1865 · rstudio/rstudio</a></p></li>
</ul>
</div>
<div id="appendix" class="section level2">
<h2>Appendix</h2>
<div id="gpg-agent-cache-passphrase" class="section level3">
<h3>Use <code>gpg-agent</code> to cache your passphrase without a pinentry GUI</h3>
<p>If you don’t want to or can’t <a href="#install-a-pinentry-app">install a pinentry app</a>,
you can get <code>gpg-agent</code> to cache your passphrase for a fixed period of time,
say 8 hours.</p>
<p>When you start your day —
or when the cache expires —
you’ll need to sign something or commit once from the command line
to re-enter your passphrase.</p>
<p>The first step is to configure <code>gpg-agent</code>
to remember your key’s password for the day (8 hours or 28,800 seconds).</p>
<pre class="bash"><code># ~/.gnupg/gpg-agent.conf
default-cache-ttl 28800
max-cache-ttl 28800</code></pre>
<p>You’ll need to restart <code>gpg-agent</code> so that it picks up the new configuration.</p>
<pre class="bash"><code>gpgconf --kill gpg-agent</code></pre>
<p>At this point,
any <code>git commit</code> will automatically be signed using your default key.
The first commit of the day
will require you to enter your password,
which does mean that
the RStudio Git UI won’t be able to sign the first commit
until you’ve asked <code>gpg</code> to sign something for you.</p>
<p>To get around this,
you can unlock your gpg key by signing <em>anything</em>
at the start of your work day
or whenever the 8 hour time limit runs out.</p>
<pre class="bash"><code>echo &quot;open sesame&quot; | gpg -s &gt; /dev/null
# prompt for password </code></pre>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Windows users, I’m sorry! I don’t own anything that runs Windows. 😒<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>You’ll need <code>git</code> version 2.0 or later. Check with <code>git --version</code> or upgrade git to the latest version with <code>brew install git</code>.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p><a href="https://en.wikipedia.org/wiki/Keybase" class="uri">https://en.wikipedia.org/wiki/Keybase</a><a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>You could also create a GPG/PGP key in the Keybase app in the identities section of your profile, but I’m using the command line so it’s easier to copy-paste.<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
