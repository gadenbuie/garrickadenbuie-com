---
title: Printing xaringan slides with chromote
author: Garrick Aden-Buie
date: '2021-01-25'
slug: print-xaringan-chromote
categories:
  - Blog
tags:
  - R
  - xaringan
  - xaringanExtra
  - Slides
  - Tips
  - Scripts
description: Create PDF versions of complicated xaringan slides using {chromote} and a little magic.
rmd_source: 'https://github.com/gadenbuie/garrickadenbuie-com/tree/main/content/blog/2021/print-xaringan-chromote/index.Rmd'
keywords: rstats
editor_options:
  chunk_output_type: console
---

<script src="{{< blogdown/postref >}}index_files/header-attrs-2.6/header-attrs.js"></script>
<script src="{{< blogdown/postref >}}index_files/clipboard-2.0.6/clipboard.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/xaringanExtra-clipboard-0.2.4/xaringanExtra-clipboard.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/xaringanExtra-clipboard-0.2.4/xaringanExtra-clipboard.js"></script>
<script>window.xaringanExtraClipboard('pre.r', {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>


<!-- Links -->
<div class="lead">
<p>There are a number of options for producing PDF versions of <span class="pkg"><a href="https://github.com/yihui/xaringan">xaringan</a></span> slides,
provided you use the standard <span class="pkg">xaringan</span> features.</p>
<p>If you add interactive elements,
like <a href="https://pkg.garrickadenbuie.com/xaringanExtra/#/panelset">panelsets</a> from <span class="pkg"><a href="https://pkg.garrickadenbuie.com/xaringanExtra">xaringanExtra</a></span>,
printing your slides to convert them to PDF may not capture everything in your slides.</p>
<p>This post demonstrates a function that uses <span class="pkg"><a href="https://github.com/rstudio/chromote">chromote</a></span>
to print <span class="pkg">xaringan</span> slides to PDF files that should give better results,
in particular when using <a href="https://pkg.garrickadenbuie.com/xaringanExtra/#/panelset">panelsets</a>.</p>
</div>
<div id="the-problem" class="section level2">
<h2>The Problem</h2>
<p>Typically, it’s fairly easy to convert <span class="pkg">xaringan</span> slides to PDF.
There are three methods that I’ve used that each work well
and produce relatively similar results:</p>
<ol style="list-style-type: decimal">
<li><p>Print the slides from a browser. Typically this works best in Chrome.</p></li>
<li><p>Use <code>xaringan::decktape()</code> to virtually print the slides to PDF.
This requires docker or an installed version of the <a href="https://github.com/astefanutti/decktape">decktape.js</a> utility.</p></li>
<li><p>Use <code>pagedown::chrome_print()</code>. This is similar to the first option,
but uses a <a href="#headless">headless</a> version of Chrome to do the printing
behind the scenes.</p></li>
</ol>
<p>These methods all work well but have one significant drawback:
they don’t work well with <span class="pkg">xaringanExtra</span>’s <a href="https://pkg.garrickadenbuie.com/xaringanExtra/#/panelset">panelsets</a>.
The problem with the panelsets is that they essentially add “within-slide” slides.
All of the panels are contained in a single slide,
so when printed,
only the first panel in the panelset is shown.</p>
</div>
<div id="the-idea" class="section level2">
<h2>The Idea</h2>
<p>The solution is easy but took me a bit of fiddling to figure out:
we use <span class="pkg">chromote</span> to control our own headless version of Chrome.
Then we ask a programmatic monkey to push the <kbd>→</kbd> button repeatedly,
once per second(-ish),
to advance through the slides,
printing each slide to its own PDF.</p>
<p>Once all the slides are printed,
we ask our monkey assistant to please staple the slides together into one (big) PDF file.
All of this happens inside a headless Chrome browser controlled by <span class="pkg">chromote</span>.</p>
<p>That’s it!
And okay, the monkey assistant is actually a little bit of JavaScript that mashes a virtual right arrow key.
And the stapler is actually the fantastic <span class="pkg"><a href="https://docs.ropensci.org/pdftools">pdftools</a></span> package.</p>
<p>Oh, and <a id="headless"><em>headless</em></a> isn’t as spooky as it sounds.
Basically it’s Chrome without the <em>chrome</em>.
In other words,
it’s a version of Chrome that runs as a command line utility
and doesn’t have a user interface that you can click around in.
Instead, you communicate with the browser by sending it commands,
all of which are made easier by <span class="pkg">chromote</span>.</p>
</div>
<div id="the-solution" class="section level2">
<h2>The Solution</h2>
<p>I’ve written a function, <code>xaringan_to_pdf()</code>,
that you can point either at your slides online or your at local rendered slides (which may require <code>file://</code> before the full path to the <code>.html</code> file).</p>
<p>You can <a href="#the-code">copy the code below</a>, or you can source it from <a href="https://gist.github.com/gadenbuie/f6b8ec0335bdd45ed5a68bead60ef4fa">this gist</a> using the code and shortlink below<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.
<em>Please check the source before you run it!</em></p>
<pre class="r"><code>source(&quot;https://git.io/xaringan2pdf&quot;)</code></pre>
<p>Running <code>xaringan_to_pdf()</code> will walk through your slides,
printing them one-by-one,
and returning one big PDF file.
I’m not linking one here because they can be <em>big</em>.</p>
<pre id="asciicast"><img src="asciicast-xaringan2pdf.svg"></pre>
</div>
<div id="the-code" class="section level2">
<h2>The Code</h2>
<p>Before you can print your slides with <code>xaringan_to_pdf()</code>, you’ll need a few things:</p>
<ol style="list-style-type: decimal">
<li><p><a href="https://www.google.com/chrome/">Google Chrome</a></p></li>
<li><p>The <span class="pkg">chromote</span> package, which isn’t on CRAN yet:</p>
<pre class="r"><code>remotes::install_github(&quot;rstudio/chromote&quot;)</code></pre></li>
<li><p>A few other packages that you can get from CRAN:</p>
<pre class="r"><code>install.packages(c(&quot;progress&quot;, &quot;jsonlite&quot;, &quot;pdftools&quot;, &quot;digest&quot;))</code></pre></li>
</ol>
<p>Once you have those things installed and ready to go,
copy the source code below and then run <code>xaringan_to_pdf()</code> to print your slides!</p>
<p>If you have any problems with the code,
feel free to <a href="https://gist.github.com/gadenbuie/f6b8ec0335bdd45ed5a68bead60ef4fa">leave a comment on the gist</a>.</p>
<style type="text/css">
.gist { display: none; }
#xaringan-chromote-print-r {
  max-height: 80vh;
  overflow-y: auto;
}
#asciicast > img {
  margin-bottom: 0;
}
</style>
<pre class="r"><code id = "xaringan-chromote-print-r">#' Print xaringan slides to PDF
#'
#' Prints xaringan slides to a PDF file, even complicated slides
#' with panelsets or other html widgets or advanced features.
#' Requires a local installation of Chrome.
#'
#' @param url The url to the xaringan slides, either online or local.
#'   If the slides are stored locally, you may need to add `file://`
#'   before the complete file path.
#' @param path The path where the PDF file should be saved
#' @param delay Seconds of delay between advancing to and printing
#'   a new slide.
xaringan_to_pdf <- function(
  url, 
  path = paste0(basename(dirname(url)), ".pdf"), 
  delay = 0.5
) {
  if (!requireNamespace("chromote", quietly = TRUE)) {
    stop("`chromote` is required: devtools::install_github('rstudio/chromote')")
  }
  required_packages <- c("progress", "jsonlite", "pdftools", "digest")
  for (pkg in required_packages) {
    if (!requireNamespace(pkg, quietly = TRUE)) {
      stop("`", pkg, "` is required: install.packages('", pkg, "')")
    }
  }

  b <- chromote::ChromoteSession$new()
  on.exit(b$close(), add = TRUE)

  b$Page$navigate(url, wait_ = TRUE)
  b$Page$loadEventFired()

  current_slide <- function() {
    x <- b$Runtime$evaluate("slideshow.getCurrentSlideIndex()")$result$value
    as.integer(x) + 1L
  }

  hash_current_slide <- function() {
    digest::digest(b$Runtime$evaluate(
      "document.querySelector('.remark-visible').innerHTML"
    )$result$value)
  }

  get_ratio <- function() {
    r <- b$Runtime$evaluate('slideshow.getRatio()')$result$value
    r <- lapply(strsplit(r, ":"), as.integer)
    width <- r[[1]][1]
    height <- r[[1]][2]
    page_width <- 8/width * width
    list(
      width = as.integer(908 * width / height),
      height = 681L,
      page = list(width = page_width, height = page_width * height / width)
    )
  }

  slide_size <- get_ratio()

  expected_slides <- as.integer(
    b$Runtime$evaluate("slideshow.getSlideCount()")$result$value
  )

  max_slides <- expected_slides * 4

  b$Browser$setWindowBounds(1, bounds = list(
    width = slide_size$width, 
    height = slide_size$height
  ))

  b$Emulation$setEmulatedMedia("print")
  b$Runtime$evaluate(paste0(
    "let style = document.createElement('style')\n",
    "style.innerText = '@media print { ",
    ".remark-slide-container:not(.remark-visible){ display:none; ",
    "}}'\n",
    "document.head.appendChild(style)"
  ))

  pb <- progress::progress_bar$new(
    format = "Slide :slide (:part) [:bar] Eta: :eta", 
    total = expected_slides
  )

  idx_slide <- current_slide()
  last_hash <- ""
  idx_part <- 0L
  pdf_files <- c()
  for (i in seq_len(max_slides)) {
    if (i > 1) {
      b$Input$dispatchKeyEvent(
        "rawKeyDown", 
        windowsVirtualKeyCode = 39, 
        code = "ArrowRight", 
        key = "ArrowRight", 
        wait_ = TRUE
      )
      Sys.sleep(delay)
    }

    if (current_slide() == idx_slide) {
      step <- 0L
      idx_part <- idx_part + 1L
    } else {
      step <- 1L
      idx_part <- 1L
    }
    idx_slide <- current_slide()
    pb$tick(step, tokens = list(slide = idx_slide, part = idx_part))

    this_hash <- hash_current_slide()
    if (identical(last_hash, this_hash)) break
    last_hash <- this_hash

    pdf_file_promise <- b$Page$printToPDF(
      landscape = TRUE,
      printBackground = TRUE,
      paperWidth = 12,
      paperHeight = 9,
      marginTop = 0,
      marginRight = 0,
      marginBottom = 0,
      marginLeft = 0,
      pageRanges = "1",
      preferCSSPageSize = TRUE,
      wait_ = FALSE
    )$then(function(value) {
      filename <- tempfile(fileext = ".pdf")
      writeBin(jsonlite::base64_dec(value$data), filename)
      filename
    })
    pdf_files <- c(pdf_files, b$wait_for(pdf_file_promise))
  }

  pdftools::pdf_combine(pdf_files, output = path)
  file.remove(pdf_files)

  invisible(path)
}</code></pre>

<script
  type="text/javascript"
  src="https://gist.github.com/f6b8ec0335bdd45ed5a68bead60ef4fa.js?file=xaringan-chromote-print.R"
></script>
<script type="text/javascript">
var code = []
document.addEventListener('DOMContentLoaded', function() {
  var gist = document.querySelectorAll('.gist .file .js-file-line')
  if (gist.length) {
    gist.forEach(function(el) {
      code.push(el.textContent)
    })
    var rscript = document.getElementById('xaringan-chromote-print-r')
    rscript.classList = 'r'
    rscript.textContent = code.join('\n').replace(/\n\n/g, '\n')
    hljs.highlightBlock(rscript)
  }
})
</script>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>I wasn’t really sure where to put this function. Maybe I’ll eventually add it to <span class="pkg">xaringanExtra</span>, but for now it’ll live here where hopefully it can still be useful to you!<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
